为了确保未登录的用户无法访问管理后台，也就是 `index.html` 页面，可以使用身份验证中间件进行保护。您已经在代码中部分实现了这一点。接下来，我将提供完整的代码，以确保所有请求到 `index.html` 的路由都经过身份验证。

### 更新后的 `server.js`

确保 `server.js` 文件中，未登录用户访问 `/` 时会被重定向到登录页面。

```javascript
// server.js
const express = require('express');
const fs = require('fs');
const path = require('path');
const bodyParser = require('body-parser');
const cookieParser = require('cookie-parser');
const bcrypt = require('bcrypt');
const https = require('https');

const app = express();
const PORT = 3000;

// HTTPS 设置 (请提供有效的证书和私钥)
const options = {
    key: fs.readFileSync('/root/nftables-nat-rust-webui/ssl/private-key.pem'),
    cert: fs.readFileSync('/root/nftables-nat-rust-webui/ssl/certificate.pem')
};

// 中间件
app.use(bodyParser.json());
app.use(express.static(path.join(__dirname, 'public')));
app.use(express.urlencoded({ extended: true }));
app.use(cookieParser());

// 读取和处理密码
let users = {};
fs.readFile('passwd.md', 'utf8', (err, data) => {
    if (err) {
        console.error(err);
        process.exit(1);
    }
    const lines = data.trim().split('\n');
    lines.forEach(line => {
        const [user, hashedPassword] = line.split(':');
        users[user] = hashedPassword;
    });
});

// 从 /etc/nat.conf 读取规则
let rules = [];
const readRulesFile = () => {
    fs.readFile('/etc/nat.conf', 'utf8', (err, data) => {
        if (err) {
            console.error('读取配置文件失败:', err);
            return;
        }
        rules = data.trim().split('\n').map(line => {
            line = line.split('#')[0].trim(); // 移除注释
            return line ? line.split(',') : null;
        }).filter(Boolean).map(parts => {
            return {
                type: parts[0],
                startPort: parts[1],
                endPort: parts[2] || null,
                destination: parts[3]
            };
        });
    });
};
readRulesFile();

// 身份验证中间件
function isAuthenticated(req, res, next) {
    if (req.cookies.auth) {
        return next();
    } else {
        // 这里将未认证用户重定向至登录页面
        res.redirect('/login');
    }
}

// 路由: 登录页面
app.get('/login', (req, res) => {
    if (req.cookies.auth) {
        return res.redirect('/'); // 若已登录则重定向到主页
    }
    res.sendFile(path.join(__dirname, 'public/login.html'));
});

// 路由: 主页，需身份验证
app.get('/', isAuthenticated, (req, res) => {
    res.sendFile(path.join(__dirname, 'public/index.html'));
});

// 路由: 登录请求处理
app.post('/login', async (req, res) => {
    const { username, password } = req.body;
    const hashedPassword = users[username];

    if (hashedPassword && await bcrypt.compare(password, hashedPassword)) {
        res.cookie('auth', '1'); // 设置cookie
        res.redirect('/');
    } else {
        res.status(401).send('用户名或密码错误');
    }
});

// 其他需要身份验证的路由
app.get('/api/rules', isAuthenticated, (req, res) => {
    res.json(rules);
});

app.post('/edit-rule', isAuthenticated, (req, res) => {
    const { index, startPort, endPort, destination } = req.body;
    if (index < 0 || index >= rules.length) {
        return res.status(400).json({ message: '无效的规则索引' });
    }
    
    rules[index] = {
        type: rules[index].type,
        startPort,
        endPort,
        destination
    };
    res.json({ message: '规则编辑成功' });
});

// 处理保存规则的请求
app.post('/save-rules', isAuthenticated, (req, res) => {
    const rulesData = req.body.rules.map(rule => {
        const endPort = rule.endPort || rule.startPort; // 处理空值
        return `${rule.type},${rule.startPort},${endPort},${rule.destination}`;
    }).join('\n');

    fs.writeFile('/etc/nat.conf', rulesData, (err) => {
        if (err) {
            return res.status(500).json({ message: '保存规则失败' });
        }
        readRulesFile(); // 重新加载规则
        res.json({ message: '规则保存成功' });
    });
});

// 登出
app.post('/logout', (req, res) => {
    res.clearCookie('auth'); // 清除cookie
    res.redirect('/login'); // 重定向到登录页面
});

// 错误处理
app.use((err, req, res, next) => {
    console.error(err.stack);
    res.status(500).send('服务器内部发生错误！');
});

// 启动服务器
https.createServer(options, app).listen(PORT, () => {
    console.log(`服务器在 https://localhost:${PORT} 上运行`);
});
```

### 其他文件保持不变

其他文件 (`bcryptTool.js`, `public/index.html`, `public/login.html`) 保持不变。

### 说明

1. **登录验证**：我们增加了身份验证中间件 (`isAuthenticated`)，确保只有已登录的用户才能访问 `index.html`。
  
2. **重定向到登录页面**：如果用户未登录，访问 `/` 路径时会被自动重定向到 `/login` 页面。

3. **功能验证**：确保在未登录状态下访问根路径，浏览器会重定向到登录页面。成功登录后，用户才能访问管理页面。

通过这个修改，您的管理后台将更加安全，未登录的用户只能访问登录页面。
